<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Модуль ngx_http_js_module</title><style type="text/css">body { background: white; color: black; font-family: sans-serif; line-height: 1.4em; text-align: center; margin: 0; padding: 0; } #banner { background: black; color: #F2F2F2; line-height: 1.2em; padding: .3em 0; box-shadow: 0 5px 10px black; } #banner a { color: #00B140; } #main { text-align: left; margin: 0 auto; min-width: 32em; max-width: 64em; } #menu { float: right; width: 11em; padding: 0 .5em 1em .5em; border-left: 2px solid #DDD; } #content { margin-right: 13.5em; padding: 0 .2em 0 1.5em; } h1 { display: block; font-size: 3em; text-align: left; height: .7em; margin: 0; margin-bottom: .5em; } h1 img { width: 100%; } h2 { text-align: center; } p { text-align: justify; } table.news p { margin-top: 0; } table.news td { vertical-align: baseline; } table.news .date { text-align: right; padding-right: 0.5em; white-space: nowrap; } table.donors td { vertical-align: baseline; } table.donors li { text-align: left; } div.directive { background: #F2F2F2; line-height: 1em; margin: 1em 0 1em -1em; padding: .7em .7em .7em 1em; border-top: 2px solid #DDD; } div.directive th { padding-left: 0; padding-right: .5em; vertical-align: baseline; text-align: left; font-weight: normal; } div.directive td { vertical-align: baseline; } div.directive pre { padding: 0; margin: 0; } div.directive p { margin: .5em 0 0 .1em; font-size: .8em; } a.notrans { color: gray; text-decoration:none; } span.initial { font-size: 200%; float: left; padding-right: 10pt;} ul, ol { margin: .5em 0 1em 1em; padding: 0 .5em; } ol { list-style-position: inside; } li { text-align: justify; padding: .5em 0 0 1px; } .compact li { padding-top: 0; } dl { margin: .5em 0 1em 0; } dt { margin: .5em 0; } .compact dt { margin-bottom: .2em; } dd { margin-left: 1.5em; padding-left: 1px; text-align: justify; } td.list { background: #F2F2F2; } blockquote { margin: 1em 0 1em 1em; padding: .5em; } li blockquote, dd blockquote { margin: .7em 0; } blockquote.note { border: 1px dotted #999; line-height: 1.2em; text-align: justify; } blockquote.example { line-height: 1em; border-left: 1px solid #BBB; } blockquote.example pre { padding: 0; margin: 0; } sup { font-size: 50%; } .video { position: relative; padding-bottom: 56.25%; overflow: hidden; } .video iframe, .video object, .video embed { position: absolute; top:0; left:0; width:100%; height:100%; }</style><script>
        window.addEventListener("load", function(e) {
            fetch("../../../banner/banner.html")
                .then((response) => response.text())
                .then((resp) => {
                    document.getElementById("banner").innerHTML = resp;
                })
                .catch((error) => {
                    console.warn(error);
                });
        });
    </script></head><body><div id="banner"></div><div id="main"><div id="menu"><h1><a href="/"><img src="/nginx.png" alt="nginx"></a></h1><div><a href="../../../en/docs/http/ngx_http_js_module.html">english</a><br>русский<br><br><a href="../../../">новости</a> [en]<br><a href="../../../ru/">об nginx</a><br><a href="../../../ru/download.html">скачать</a><br><a href="../../../en/security_advisories.html">безопасность</a> [en]<br><a href="../../../ru/docs/">документация</a><br><a href="../../../ru/docs/faq.html">faq</a><br><a href="../../../en/books.html">книги</a> [en]<br><a href="../../../ru/support.html">поддержка</a><br><br><a href="http://trac.nginx.org/nginx">trac</a><br><a href="http://twitter.com/nginxorg">twitter</a><br><a href="https://www.nginx.com/blog/">blog</a><br><br><a href="https://unit.nginx.org/">unit</a><br><a href="../../../ru/docs/njs/">njs</a><br></div></div><div id="content"><h2>Модуль ngx_http_js_module</h2><table width="100%"><tr><td align="left"><a href="#example">Пример конфигурации</a><br><a href="#directives">Директивы</a><br>     <a href="#js_body_filter">js_body_filter</a><br>     <a href="#js_content">js_content</a><br>     <a href="#js_fetch_buffer_size">js_fetch_buffer_size</a><br>     <a href="#js_fetch_ciphers">js_fetch_ciphers</a><br>     <a href="#js_fetch_max_response_buffer_size">js_fetch_max_response_buffer_size</a><br>     <a href="#js_fetch_protocols">js_fetch_protocols</a><br>     <a href="#js_fetch_timeout">js_fetch_timeout</a><br>     <a href="#js_fetch_trusted_certificate">js_fetch_trusted_certificate</a><br>     <a href="#js_fetch_verify">js_fetch_verify</a><br>     <a href="#js_fetch_verify_depth">js_fetch_verify_depth</a><br>     <a href="#js_header_filter">js_header_filter</a><br>     <a href="#js_import">js_import</a><br>     <a href="#js_include">js_include</a><br>     <a href="#js_path">js_path</a><br>     <a href="#js_periodic">js_periodic</a><br>     <a href="#js_preload_object">js_preload_object</a><br>     <a href="#js_set">js_set</a><br>     <a href="#js_shared_dict_zone">js_shared_dict_zone</a><br>     <a href="#js_var">js_var</a><br><a href="#arguments">Аргумент запроса</a><br></td></tr></table>

<a name="summary"></a><p>
Модуль <code>ngx_http_js_module</code> позволяет задавать
обработчики location и переменных
на <a href="../njs/index.html">njs</a> —
подмножестве языка JavaScript.
</p><p>
Инструкция по сборке и установке доступны
<a href="../njs/install.html">здесь</a>.
</p>


<a name="example"></a><center><h4>Пример конфигурации</h4></center><p>
Пример работает начиная с версии
<a href="../njs/changes.html#njs0.4.0">0.4.0</a>.
</p> <blockquote class="example"><pre>
http {
    js_import http.js;

    js_set $foo     http.foo;
    js_set $summary http.summary;
    js_set $hash    http.hash;

    resolver 10.0.0.1;

    server {
        listen 8000;

        location / {
            add_header X-Foo $foo;
            js_content http.baz;
        }

        location = /summary {
            return 200 $summary;
        }

        location = /hello {
            js_content http.hello;
        }

        # начиная с версии 0.7.0
        location = /fetch {
            js_content                   http.fetch;
            js_fetch_trusted_certificate /path/to/ISRG_Root_X1.pem;
        }

        # начиная с версии 0.7.0
        location = /crypto {
            add_header Hash $hash;
            return     200;
        }
    }
}
</pre></blockquote><p> 
</p><p>
Файл <code>http.js</code>:
</p> <blockquote class="example"><pre>
function foo(r) {
    r.log("hello from foo() handler");
    return "foo";
}

function summary(r) {
    var a, s, h;

    s = "JS summary\n\n";

    s += "Method: " + r.method + "\n";
    s += "HTTP version: " + r.httpVersion + "\n";
    s += "Host: " + r.headersIn.host + "\n";
    s += "Remote Address: " + r.remoteAddress + "\n";
    s += "URI: " + r.uri + "\n";

    s += "Headers:\n";
    for (h in r.headersIn) {
        s += "  header '" + h + "' is '" + r.headersIn[h] + "'\n";
    }

    s += "Args:\n";
    for (a in r.args) {
        s += "  arg '" + a + "' is '" + r.args[a] + "'\n";
    }

    return s;
}

function baz(r) {
    r.status = 200;
    r.headersOut.foo = 1234;
    r.headersOut['Content-Type'] = "text/plain; charset=utf-8";
    r.headersOut['Content-Length'] = 15;
    r.sendHeader();
    r.send("nginx");
    r.send("java");
    r.send("script");

    r.finish();
}

function hello(r) {
    r.return(200, "Hello world!");
}

// начиная с версии 0.7.0
async function fetch(r) {
    let results = await Promise.all([ngx.fetch('https://nginx.org/'),
                                     ngx.fetch('https://nginx.org/en/')]);

    r.return(200, JSON.stringify(results, undefined, 4));
}

// начиная с версии 0.7.0
async function hash(r) {
    let hash = await crypto.subtle.digest('SHA-512', r.headersIn.host);
    r.setReturnValue(Buffer.from(hash).toString('hex'));
}

export default {foo, summary, baz, hello, fetch, hash};
</pre></blockquote><p> 
</p>


<a name="directives"></a><center><h4>Директивы</h4></center><a name="js_body_filter"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_body_filter</strong> <code><i>функция</i></code> | <code><i>модуль.функция</i></code>
[<code><i>buffer_type</i></code>=<code><i>строка</i></code> | <code><i>буфер</i></code>];</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>location</code>, <code>if in location</code>, <code>limit_except</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.5.2.
            </p></div><p>
Задаёт функцию njs в качестве фильтра тела ответа.
Функция фильтра вызывается для каждого блока данных тела ответа
со следующими аргументами:

</p> <dl class="compact">
<dt><code>r</code></dt>
<dd>
объект <a href="../njs/reference.html#http">HTTP request</a>
</dd>

<dt><code>data</code></dt>
<dd>
входящий блок данных
может быть строкой или буфером
в зависимости от значения <code>buffer_type</code>,
по умолчанию является строкой.
</dd>

<dt><code>flags</code></dt>
<dd>
объект со следующими свойствами:
<dl class="compact">
<dt><code>last</code></dt>
<dd>
логическое значение, true, если данные являются последним буфером.
</dd>

</dl>
</dd>

</dl><p> 
</p><p>
Функция фильтра может передавать свою модифицированную версию
входящего блока данных следующему фильтру тела ответа при помощи вызова
<a href="../njs/reference.html#r_sendbuffer"><code>r.sendBuffer()</code></a>.
Пример преобразования букв в нижний регистр в теле ответа:
</p> <blockquote class="example"><pre>
function filter(r, data, flags) {
    r.sendBuffer(data.toLowerCase(), flags);
}
</pre></blockquote><p> 
Для отмены фильтра (блоки данных будут передаваться клиенту
без вызова <code>js_body_filter</code>),
можно использовать
<a href="../njs/reference.html#r_done"><code>r.done()</code></a>.
</p><p>
Если функция фильтра изменяет длину тела ответа, то
необходимо очистить заголовок ответа “Content-Length”
(если присутствует) в
<a href="#js_header_filter"><code>js_header_filter</code></a>,
чтобы применить поблочное кодирование.
</p><p>
</p> <blockquote class="note">
Так как обработчик <code>js_body_filter</code>
должен сразу возвращать результат,
то поддерживаются только синхронные операции,
Таким образом, асинхронные операции, например
<a href="../njs/reference.html#r_subrequest">r.subrequest()</a>
или
<a href="../njs/reference.html#settimeout">setTimeout()</a>,
не поддерживаются.
</blockquote><p> 
</p><p>
</p> <blockquote class="note">
Директива может быть указана внутри
блока <a href="../http/ngx_http_rewrite_module.html#if">if</a>
начиная с <a href="../njs/changes.html#njs0.7.7">0.7.7</a>.
</blockquote><p> 
</p><a name="js_content"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_content</strong> <code><i>функция</i></code> | <code><i>модуль.функция</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>location</code>, <code>if in location</code>, <code>limit_except</code><br>
                </td>
                </tr>
            </table></div><p>
Задаёт функцию njs в качестве обработчика содержимого location.
Начиная с версии <a href="../njs/changes.html#njs0.4.0">0.4.0</a>
можно ссылаться на функцию модуля.
</p><p>
</p> <blockquote class="note">
Директива может быть указана внутри
блока <a href="../http/ngx_http_rewrite_module.html#if">if</a>
начиная с <a href="../njs/changes.html#njs0.7.7">0.7.7</a>.
</blockquote><p> 
</p><a name="js_fetch_buffer_size"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_fetch_buffer_size</strong> <code><i>размер</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            <pre>js_fetch_buffer_size 16k;</pre>
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.4.
            </p></div><p>
Задаёт <code><i>размер</i></code> буфера, который будет использоваться
для чтения и записи для
<a href="../njs/reference.html#ngx_fetch">Fetch API</a>.
</p><a name="js_fetch_ciphers"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_fetch_ciphers</strong> <code><i>шифры</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            <pre>js_fetch_ciphers HIGH:!aNULL:!MD5;</pre>
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.0.
            </p></div><p>
Описывает разрешённые шифры для HTTPS-запросов
при помощи <a href="../njs/reference.html#ngx_fetch">Fetch API</a>.
Шифры задаются в формате, поддерживаемом библиотекой OpenSSL.
</p><p>
Полный список можно посмотреть с помощью команды
“<code>openssl ciphers</code>”.
</p><a name="js_fetch_max_response_buffer_size"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_fetch_max_response_buffer_size</strong> <code><i>размер</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            <pre>js_fetch_max_response_buffer_size 1m;</pre>
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.4.
            </p></div><p>
Задаёт максимальный <code><i>размер</i></code> ответа, полученного
при помощи <a href="../njs/reference.html#ngx_fetch">Fetch API</a>.
</p><a name="js_fetch_protocols"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_fetch_protocols</strong> 
    [<code>TLSv1</code>]
    [<code>TLSv1.1</code>]
    [<code>TLSv1.2</code>]
    [<code>TLSv1.3</code>];</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            <pre>js_fetch_protocols TLSv1 TLSv1.1 TLSv1.2;</pre>
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.0.
            </p></div><p>
Разрешает указанные протоколы для HTTPS-запросов
при помощи <a href="../njs/reference.html#ngx_fetch">Fetch API</a>.
</p><a name="js_fetch_timeout"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_fetch_timeout</strong> <code><i>время</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            <pre>js_fetch_timeout 60s;</pre>
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.4.
            </p></div><p>
Задаёт таймаут при чтении и записи
при помощи <a href="../njs/reference.html#ngx_fetch">Fetch API</a>.
Таймаут устанавливается не на всю передачу ответа,
а только между двумя операциями чтения.
Если по истечении этого времени данные не передавались, соединение закрывается.
</p><a name="js_fetch_trusted_certificate"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_fetch_trusted_certificate</strong> <code><i>файл</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.0.
            </p></div><p>
Задаёт <code><i>файл</i></code> с доверенными сертификатами CA в формате PEM,
используемыми при
<a href="../njs/reference.html#fetch_verify">проверке</a>
HTTPS-сертификата
при помощи <a href="../njs/reference.html#ngx_fetch">Fetch API</a>.
</p><a name="js_fetch_verify"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_fetch_verify</strong> <code>on</code> | <code>off</code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            <pre>js_fetch_verify on;</pre>
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.4.
            </p></div><p>
Разрешает или запрещает проверку сертификата HTTPS-сервера
при помощи <a href="../njs/reference.html#ngx_fetch">Fetch API</a>.
</p><a name="js_fetch_verify_depth"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_fetch_verify_depth</strong> <code><i>число</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            <pre>js_fetch_verify_depth 100;</pre>
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.0.
            </p></div><p>
Устанавливает глубину проверки в цепочке HTTPS-сертификатов
при помощи <a href="../njs/reference.html#ngx_fetch">Fetch API</a>.
</p><a name="js_header_filter"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_header_filter</strong> <code><i>функция</i></code> | <code><i>модуль.функция</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>location</code>, <code>if in location</code>, <code>limit_except</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.5.1.
            </p></div><p>
Задаёт функцию njs в качестве фильтра заголовка ответа.
Директива позволяет менять произвольные поля заголовка ответа.
</p><p>
</p> <blockquote class="note">
Так как обработчик <code>js_header_filter</code>
должен сразу возвращать результат,
то поддерживаются только синхронные операции,
Таким образом, асинхронные операции, например
<a href="../njs/reference.html#r_subrequest">r.subrequest()</a>
или
<a href="../njs/reference.html#settimeout">setTimeout()</a>,
не поддерживаются.
</blockquote><p> 
</p><p>
</p> <blockquote class="note">
Директива может быть указана внутри
блока <a href="../http/ngx_http_rewrite_module.html#if">if</a>
начиная с <a href="../njs/changes.html#njs0.7.7">0.7.7</a>.
</blockquote><p> 
</p><a name="js_import"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_import</strong> <code><i>модуль.js</i></code> |
<code><i>имя_экспорта from модуль.js</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.4.0.
            </p></div><p>
Импортирует модуль, позволяющий задавать обработчики location и переменных
на njs.
<code>Имя_экспорта</code> является пространством имён
при доступе к функциям модуля.
Если <code>имя_экспорта</code> не задано,
то пространством имён будет являться имя модуля.
</p> <blockquote class="example"><pre>
js_import http.js;
</pre></blockquote><p> 
В примере при доступе к экспорту в качестве
пространства имён используется имя модуля <code>http</code>.
Если импортируемый модуль экспортирует <code>foo()</code>,
то для доступа используется <code>http.foo</code>.
</p><p>
Директив <code>js_import</code> может быть несколько.
</p><p>
</p> <blockquote class="note">
Директива может быть указана
на уровне <code>server</code> и <code>location</code>
начиная с <a href="../njs/changes.html#njs0.7.7">0.7.7</a>.
</blockquote><p> 
</p><a name="js_include"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_include</strong> <code><i>файл</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code><br>
                </td>
                </tr>
            </table></div><p>
Задаёт файл, позволяющий задавать обработчики location и переменных на njs:
</p> <blockquote class="example"><pre>
nginx.conf:
js_include http.js;
location   /version {
    js_content version;
}

http.js:
function version(r) {
    r.return(200, njs.version);
}
</pre></blockquote><p> 
</p><p>
Директива устарела в версии
<a href="../njs/changes.html#njs0.4.0">0.4.0</a>
и была удалена в версии
<a href="../njs/changes.html#njs0.7.1">0.7.1</a>.
Вместо неё следует использовать директиву <a href="#js_import">js_import</a>.
</p><a name="js_path"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_path</strong> 
<code><i>путь</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.3.0.
            </p></div><p>
Задаёт дополнительный путь для модулей njs.
</p><p>
</p> <blockquote class="note">
Директива может быть указана
на уровне <code>server</code> и <code>location</code>
начиная с <a href="../njs/changes.html#njs0.7.7">0.7.7</a>.
</blockquote><p> 
</p><a name="js_periodic"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_periodic</strong> <code><i>функция</i></code> |
        <code><i>модуль.функция</i></code>
        [<code>interval</code>=<code><i>время</i></code>]
        [<code>jitter</code>=<code><i>число</i></code>]
        [<code>worker_affinity</code>=<code><i>маска</i></code>];</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.8.1.
            </p></div><p>
Задаёт периодичность запуска обработчика содержимого.
В качестве первого аргумента обработчик получает
<a href="../njs/reference.html#periodic_session">объект сессии</a>,
также у обработчика есть доступ к глобальным объектам таким как
<a href="../njs/reference.html#ngx">ngx</a>.
</p><p>
Необязательный параметр <code>interval</code>
задаёт интервал между двумя последовательными запусками,
по умолчанию 5 секунд.
</p><p>
Необязательный параметр <code>jitter</code>
задаёт время, в пределах которого
случайным образом задерживается каждый запуск,
по умолчанию задержки нет.
</p><p>
По умолчанию <code>js_handler</code> выполняется для рабочего процесса 0.
Необязательный параметр <code>worker_affinity</code>
позволяет указать рабочий процесс,
для которого будет выполняться обработчик содержимого location.
Рабочие процессы задаются битовой маской разрешённых к использованию рабочих
процессов.
Маска <code>all</code> позволяет обработчику выполняться
для всех рабочих процессов.
</p><p>
Пример:
</p> <blockquote class="example"><pre>
example.conf:

location @periodics {
    # интервал выполнения 1 минута для рабочего процесса 0
    js_periodic main.handler interval=60s;

    # интервал выполнения 1 минута для всех рабочих процессов
    js_periodic main.handler interval=60s worker_affinity=all;

    # интервал выполнения 1 минута для рабочих процессов 1 и 3
    js_periodic main.handler interval=60s worker_affinity=0101;

    resolver 10.0.0.1;
    js_fetch_trusted_certificate /path/to/ISRG_Root_X1.pem;
}

example.js:

async function handler(s) {
    let reply = await ngx.fetch('https://nginx.org/en/docs/njs/');
    let body = await reply.text();

    ngx.log(ngx.INFO, body);
}
</pre></blockquote><p> 
</p><a name="js_preload_object"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_preload_object</strong> <code><i>имя.json</i></code> |
<code><i>имя</i></code> from <code><i>файл.json</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.7.8.
            </p></div><p>
Предварительно загружает
<a href="../njs/preload_objects.html">неизменяемый объект</a>
во время конфигурации.
<code>Имя</code> используется в качестве имени глобальной переменной,
через которую объект доступен в коде njs.
Если <code>имя</code> не указано,
то будет использоваться имя файла.
</p> <blockquote class="example"><pre>
js_preload_object map.json;
</pre></blockquote><p> 
В примере <code>map</code> используется в качестве имени
во время доступа к предварительно загруженному объекту.
</p><p>
Директив <code>js_preload_object</code> может быть несколько.
</p><a name="js_set"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_set</strong> 
<code><i>$переменная</i></code> <code><i>функция</i></code> |
<code><i>модуль.функция</i></code>;</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table></div><p>
Задаёт <code>функцию</code> njs
для указанной <code>переменной</code>.
Начиная с <a href="../njs/changes.html#njs0.4.0">0.4.0</a>
можно ссылаться на функцию модуля.
</p><p>
Функция вызывается в момент
первого обращения к переменной для данного запроса.
Точный момент вызова функции зависит от
<a href="../dev/development_guide.html#http_phases">фазы</a>,
в которой происходит обращение к переменной.
Это можно использовать для реализации дополнительной логики,
не относящейся к вычислению переменной.
Например, если переменная указана
в директиве <a href="ngx_http_log_module.html#log_format">log_format</a>,
то её обработчик не будет выполняться до фазы записи в лог.
Этот обработчик также может использоваться для выполнения процедур
непосредственно перед освобождением запроса.
</p><p>
</p> <blockquote class="note">
Так как обработчик <code>js_set</code>
должен сразу возвращать результат,
то поддерживаются только синхронные операции,
Таким образом, асинхронные операции, например
<a href="../njs/reference.html#r_subrequest">r.subrequest()</a>
или
<a href="../njs/reference.html#settimeout">setTimeout()</a>,
не поддерживаются.
</blockquote><p> 
</p><p>
</p> <blockquote class="note">
Директива может быть указана
на уровне <code>server</code> и <code>location</code>
начиная с <a href="../njs/changes.html#njs0.7.7">0.7.7</a>.
</blockquote><p> 
</p><a name="js_shared_dict_zone"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_shared_dict_zone</strong> 
    <code>zone</code>=<code><i>имя</i></code>:<code><i>размер</i></code>
    [<code>timeout</code>=<code><i>время</i></code>]
    [<code>type</code>=<code>строка</code>|<code>число</code>]
    [<code>evict</code>];</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.8.0.
            </p></div><p>
Задаёт <code><i>имя</i></code> и <code><i>размер</i></code> зоны разделяемой памяти,
в которой хранится
<a href="../njs/reference.html#dict">словарь</a> ключей и значений,
разделяемый между рабочими процессами.
</p><p>
По умолчанию в качестве ключа и значения используется строка.
Необязательный параметр <code>type</code>
позволяет изменить тип значения на число.
</p><p>
Необязательный параметр <code>timeout</code> задаёт время,
по завершении которого все записи в словаре удаляются из зоны.
</p><p>
Необязательный параметр <code>evict</code> удаляет самую старую
пару ключ-значение при переполнении зоны.
</p><p>
Пример:
</p> <blockquote class="example"><pre>
example.conf:
    # Создаётся словарь размером 1Мб со строковыми значениями,
    # пары ключ-значение удаляются при отсутствии активности в течение 60 секунд:
    js_shared_dict_zone zone=foo:1M timeout=60s;

    # Создаётся словарь размером 512Кб со строковыми значениями,
    # удаляется самая старая пара ключ-значение при переполнении зоны:
    js_shared_dict_zone zone=bar:512K timeout=30s evict;

    # Создаётся постоянный словарь размером 32Кб с числовыми значениями:
    js_shared_dict_zone zone=num:32k type=number;

example.js:
    function get(r) {
        r.return(200, ngx.shared.foo.get(r.args.key));
    }

    function set(r) {
        r.return(200, ngx.shared.foo.set(r.args.key, r.args.value));
    }

    function del(r) {
        r.return(200, ngx.shared.bar.delete(r.args.key));
    }

    function increment(r) {
        r.return(200, ngx.shared.num.incr(r.args.key, 2));
    }
</pre></blockquote><p> 
</p><a name="js_var"></a><div class="directive"><table cellspacing="0">
                <tr>
                <th>
            Синтаксис:
                </th>
                <td>
            <code><strong>js_var</strong> <code><i>$переменная</i></code> [<code><i>значение</i></code>];</code><br>
                </td>
                </tr>
            
                <tr>
                <th>
            Умолчание:
                </th>
                <td>
            
            —
        
                </td>
                </tr>
            
                <tr>
                <th>
            Контекст:
                </th>
                <td>
            <code>http</code>, <code>server</code>, <code>location</code><br>
                </td>
                </tr>
            </table><p>Эта директива появилась в версии 0.5.3.
            </p></div><p>
Объявляет
<a href="../njs/reference.html#r_variables">перезаписываемую</a>
переменную.
В качестве значения можно использовать текст, переменные и их комбинации.
Переменная не перезаписывается после перенаправления,
в отличие от переменных, созданных при помощи
директивы <a href="ngx_http_rewrite_module.html#set">set</a>.
</p><p>
</p> <blockquote class="note">
Директива может быть указана
на уровне <code>server</code> и <code>location</code>
начиная с <a href="../njs/changes.html#njs0.7.7">0.7.7</a>.
</blockquote><p> 
</p>


<a name="arguments"></a><center><h4>Аргумент запроса</h4></center><p>
Каждый HTTP-обработчик njs получает один аргумент,
<a href="../njs/reference.html#http">объект</a> запроса.
</p>

</div></div></body></html>
