<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Using node modules with njs</title><style type="text/css">body { background: white; color: black; font-family: sans-serif; line-height: 1.4em; text-align: center; margin: 0; padding: 0; } #banner { background: black; color: #F2F2F2; line-height: 1.2em; padding: .3em 0; box-shadow: 0 5px 10px black; } #banner a { color: #00B140; } #main { text-align: left; margin: 0 auto; min-width: 32em; max-width: 64em; } #menu { float: right; width: 11em; padding: 0 .5em 1em .5em; border-left: 2px solid #DDD; } #content { margin-right: 13.5em; padding: 0 .2em 0 1.5em; } h1 { display: block; font-size: 3em; text-align: left; height: .7em; margin: 0; margin-bottom: .5em; } h1 img { width: 100%; } h2 { text-align: center; } p { text-align: justify; } table.news p { margin-top: 0; } table.news td { vertical-align: baseline; } table.news .date { text-align: right; padding-right: 0.5em; white-space: nowrap; } table.donors td { vertical-align: baseline; } table.donors li { text-align: left; } div.directive { background: #F2F2F2; line-height: 1em; margin: 1em 0 1em -1em; padding: .7em .7em .7em 1em; border-top: 2px solid #DDD; } div.directive th { padding-left: 0; padding-right: .5em; vertical-align: baseline; text-align: left; font-weight: normal; } div.directive td { vertical-align: baseline; } div.directive pre { padding: 0; margin: 0; } div.directive p { margin: .5em 0 0 .1em; font-size: .8em; } a.notrans { color: gray; text-decoration:none; } span.initial { font-size: 200%; float: left; padding-right: 10pt;} ul, ol { margin: .5em 0 1em 1em; padding: 0 .5em; } ol { list-style-position: inside; } li { text-align: justify; padding: .5em 0 0 1px; } .compact li { padding-top: 0; } dl { margin: .5em 0 1em 0; } dt { margin: .5em 0; } .compact dt { margin-bottom: .2em; } dd { margin-left: 1.5em; padding-left: 1px; text-align: justify; } td.list { background: #F2F2F2; } blockquote { margin: 1em 0 1em 1em; padding: .5em; } li blockquote, dd blockquote { margin: .7em 0; } blockquote.note { border: 1px dotted #999; line-height: 1.2em; text-align: justify; } blockquote.example { line-height: 1em; border-left: 1px solid #BBB; } blockquote.example pre { padding: 0; margin: 0; } sup { font-size: 50%; } .video { position: relative; padding-bottom: 56.25%; overflow: hidden; } .video iframe, .video object, .video embed { position: absolute; top:0; left:0; width:100%; height:100%; }</style><script>
        window.addEventListener("load", function(e) {
            fetch("../../../banner/banner.html")
                .then((response) => response.text())
                .then((resp) => {
                    document.getElementById("banner").innerHTML = resp;
                })
                .catch((error) => {
                    console.warn(error);
                });
        });
    </script></head><body><div id="banner"></div><div id="main"><div id="menu"><h1><a href="/"><img src="/nginx.png" alt="nginx"></a></h1><div>english<br><a href="../../../ru/docs/njs/node_modules.html">русский</a><br><br><a href="../../../">news</a><br><a href="../../../en/">about</a><br><a href="../../../en/download.html">download</a><br><a href="../../../en/security_advisories.html">security</a><br><a href="../../../en/docs/">documentation</a><br><a href="../../../en/docs/faq.html">faq</a><br><a href="../../../en/books.html">books</a><br><a href="../../../en/support.html">support</a><br><br><a href="http://trac.nginx.org/nginx">trac</a><br><a href="http://twitter.com/nginxorg">twitter</a><br><a href="https://www.nginx.com/blog/">blog</a><br><br><a href="https://unit.nginx.org/">unit</a><br><a href="./">njs</a><br></div></div><div id="content"><h2>Using node modules with njs</h2><table width="100%"><tr><td align="left"><a href="#environment">Environment</a><br><a href="#protobuf">Protobufjs</a><br><a href="#dnspacket">DNS-packet</a><br></td></tr></table><a name="intro"></a><p>
Often, a developer wants to use 3rd-party code,
usually available as a library of some kind.
In the JavaScript world, the concept of a module is relatively new,
so there was no standard until recently.
Many platforms (browsers) still don't support modules, which makes code
reuse harder.
This article describes ways to reuse
<a href="https://nodejs.org/">Node.js</a> code in njs.
</p><blockquote class="note">
Examples in this article use features that appeared in
<a href="index.html">njs</a>
<a href="changes.html#njs0.3.8">0.3.8</a>
</blockquote><p>
There is a number of issues
that may arise when 3rd-party code is added to njs:

</p> <ul class="compact">

<li>
Multiple files that reference each other and their dependencies
</li>

<li>
Platform-specific APIs
</li>

<li>
Modern standard language constructions
</li>

</ul><p> 
</p><p>
The good news is that such problems are not something new or specific to njs.
JavaScript developers face them daily
when trying to support multiple disparate platforms
with very different properties.
There are instruments designed to resolve the above-mentioned issues.

</p> <ul class="compact">

<li>
Multiple files that reference each other, and their dependencies
<p>
This can be solved by merging all the interdependent code into a single file.
Tools like
<a href="http://browserify.org/">browserify</a> or
<a href="https://webpack.js.org/">webpack</a>
accept an entire project and produce a single file containing
your code and all the dependencies.
</p>
</li>

<li>
Platform-specific APIs
<p>
You can use multiple libraries that implement such APIs
in a platform-agnostic manner (at the expense of performance, though).
Particular features can also be implemented using the
<a href="https://polyfill.io/v3/">polyfill</a> approach.
</p>
</li>

<li>
Modern standard language constructions
<p>
Such code can be transpiled:
this means performing a number of transformations
that rewrite newer language features in accordance with an older standard.
For example, <a href="https://babeljs.io/"> babel</a> project
can be used to this purpose.
</p>
</li>

</ul><p> 
</p><p>
In this guide, we will use two relatively large npm-hosted libraries:

</p> <ul class="compact">

<li>
<a href="https://www.npmjs.com/package/protobufjs">protobufjs</a> — 
a library for creating and parsing protobuf messages used by the
<a href="https://grpc.io/">gRPC</a> protocol
</li>

<li>
<a href="https://www.npmjs.com/package/dns-packet">dns-packet</a> — 
a library for processing DNS protocol packets
</li>

</ul><p> 
</p><a name="environment"></a><center><h4>Environment</h4></center><p>
</p> <blockquote class="note">
This document mostly employs a generic approach
and avoids specific best practice advices concerning Node.js
and JavaScript.
Make sure to consult the corresponding package's manual
before following the steps suggested here.
</blockquote><p> 
First (assuming Node.js is installed and operational), let's create an
empty project and install some dependencies;
the commands below assume we are in the working directory:
</p> <blockquote class="example"><pre>
$ mkdir my_project &amp;&amp; cd my_project
$ npx license choose_your_license_here &gt; LICENSE
$ npx gitignore node

$ cat &gt; package.json &lt;&lt;EOF
{
  "name":        "foobar",
  "version":     "0.0.1",
  "description": "",
  "main":        "index.js",
  "keywords":    [],
  "author":      "somename &lt;some.email@example.com&gt; (https://example.com)",
  "license":     "some_license_here",
  "private":     true,
  "scripts": {
    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
  }
}
EOF
$ npm init -y
$ npm install browserify
</pre></blockquote><p> 
</p><a name="protobuf"></a><center><h4>Protobufjs</h4></center><p>
The library provides a parser
for the <code>.proto</code> interface definitions
and a code generator for message parsing and generation.
</p><p>
In this example, we will use the
<a href="https://github.com/grpc/grpc/blob/master/examples/protos/helloworld.proto">helloworld.proto</a>
file
from the gRPC examples.
Our goal is to create two messages:
<code>HelloRequest</code> and
<code>HelloResponse</code>.
We will use the
<a href="https://github.com/protobufjs/protobuf.js/blob/master/README.md#reflection-vs-static-code">static</a>
mode of protobufjs instead of dynamically generating classes, because
njs doesn't support adding new functions dynamically
due to security considerations.
</p><p>
Next, the library is installed and
the JavaScript code implementing message marshalling
is generated from the protocol definition:
</p> <blockquote class="example"><pre>
$ npm install protobufjs
$ npx pbjs -t static-module helloworld.proto &gt; static.js
</pre></blockquote><p> 
</p><p>
Thus, the <code>static.js</code> file becomes our new dependency,
storing all the code we need to implement message processing.
The <code>set_buffer()</code> function contains code that uses the
library to create a buffer with the serialized
<code>HelloRequest</code> message.
The code resides in the <code>code.js</code> file:
</p> <blockquote class="example"><pre>
var pb = require('./static.js');

// Example usage of protobuf library: prepare a buffer to send
function set_buffer(pb)
{
    // set fields of gRPC payload
    var payload = { name: "TestString" };

    // create an object
    var message = pb.helloworld.HelloRequest.create(payload);

    // serialize object to buffer
    var buffer = pb.helloworld.HelloRequest.encode(message).finish();

    var n = buffer.length;

    var frame = new Uint8Array(5 + buffer.length);

    frame[0] = 0;                        // 'compressed' flag
    frame[1] = (n &amp; 0xFF000000) &gt;&gt;&gt; 24;  // length: uint32 in network byte order
    frame[2] = (n &amp; 0x00FF0000) &gt;&gt;&gt; 16;
    frame[3] = (n &amp; 0x0000FF00) &gt;&gt;&gt;  8;
    frame[4] = (n &amp; 0x000000FF) &gt;&gt;&gt;  0;

    frame.set(buffer, 5);

    return frame;
}

var frame = set_buffer(pb);
</pre></blockquote><p> 
</p><p>
To ensure it works, we execute the code using node:
</p> <blockquote class="example"><pre>
$ node ./code.js
Uint8Array [
    0,   0,   0,   0,  12, 10,
   10,  84, 101, 115, 116, 83,
  116, 114, 105, 110, 103
]
</pre></blockquote><p> 
You can see that this got us a properly encoded <code>gRPC</code> frame.
Now let's run it with njs:
</p> <blockquote class="example"><pre>
$ njs ./code.js
Thrown:
Error: Cannot find module "./static.js"
    at require (native)
    at main (native)
</pre></blockquote><p> 
</p><p>
Modules are not supported, so we've received an exception.
To overcome this issue, let's use <code>browserify</code>
or other similar tool.
</p><p>
An attempt to process our existing <code>code.js</code> file will result
in a bunch of JS code that is supposed to run in a browser,
i.e. immediately upon loading.
This isn't something we actually want.
Instead, we want to have an exported function that
can be referenced from the nginx configuration.
This requires some wrapper code.
</p> <blockquote class="note">
In this guide, we use
njs <a href="cli.html">cli</a> in all examples for the sake of simplicity.
In real life, you will be using nginx njs module to run your code.
</blockquote><p> 
</p><p>
The <code>load.js</code> file contains the library-loading code that
stores its handle in the global namespace:
</p> <blockquote class="example"><pre>
global.hello = require('./static.js');
</pre></blockquote><p> 
This code will be replaced with merged content.
Our code will be using the "<code>global.hello</code>" handle to access
the library.
</p><p>
Next, we process it with <code>browserify</code>
to get all dependencies into a single file:
</p> <blockquote class="example"><pre>
$ npx browserify load.js -o bundle.js -d
</pre></blockquote><p> 
The result is a huge file that contains all our dependencies:
</p> <blockquote class="example"><pre>
(function(){function......
...
...
},{"protobufjs/minimal":9}]},{},[1])
//# sourceMappingURL..............
</pre></blockquote><p> 
To get final "<code>njs_bundle.js</code>" file we concatenate
"<code>bundle.js</code>" and the following code:
</p> <blockquote class="example"><pre>
// Example usage of protobuf library: prepare a buffer to send
function set_buffer(pb)
{
    // set fields of gRPC payload
    var payload = { name: "TestString" };

    // create an object
    var message = pb.helloworld.HelloRequest.create(payload);

    // serialize object to buffer
    var buffer = pb.helloworld.HelloRequest.encode(message).finish();

    var n = buffer.length;

    var frame = new Uint8Array(5 + buffer.length);

    frame[0] = 0;                        // 'compressed' flag
    frame[1] = (n &amp; 0xFF000000) &gt;&gt;&gt; 24;  // length: uint32 in network byte order
    frame[2] = (n &amp; 0x00FF0000) &gt;&gt;&gt; 16;
    frame[3] = (n &amp; 0x0000FF00) &gt;&gt;&gt;  8;
    frame[4] = (n &amp; 0x000000FF) &gt;&gt;&gt;  0;

    frame.set(buffer, 5);

    return frame;
}

// functions to be called from outside
function setbuf()
{
    return set_buffer(global.hello);
}

// call the code
var frame = setbuf();
console.log(frame);
</pre></blockquote><p> 
Let's run the file using node to make sure things still work:
</p> <blockquote class="example"><pre>
$ node ./njs_bundle.js
Uint8Array [
    0,   0,   0,   0,  12, 10,
   10,  84, 101, 115, 116, 83,
  116, 114, 105, 110, 103
]
</pre></blockquote><p> 
Now let's proceed further with njs:
</p> <blockquote class="example"><pre>
$ njs ./njs_bundle.js
Uint8Array [0,0,0,0,12,10,10,84,101,115,116,83,116,114,105,110,103]
</pre></blockquote><p> 
The last thing will be to use njs-specific API to convert
array into byte string, so it could be usable by nginx module.
We can add the following snippet before the line
<code>return frame; }</code>:
</p> <blockquote class="example"><pre>
if (global.njs) {
    return String.bytesFrom(frame)
}
</pre></blockquote><p> 
Finally, we got it working:
</p> <blockquote class="example"><pre>
$ njs ./njs_bundle.js |hexdump -C
00000000  00 00 00 00 0c 0a 0a 54  65 73 74 53 74 72 69 6e  |.......TestStrin|
00000010  67 0a                                             |g.|
00000012
</pre></blockquote><p> 
This is the intended result.
Response parsing can be implemented similarly:
</p> <blockquote class="example"><pre>
function parse_msg(pb, msg)
{
    // convert byte string into integer array
    var bytes = msg.split('').map(v=&gt;v.charCodeAt(0));

    if (bytes.length &lt; 5) {
        throw 'message too short';
    }

    // first 5 bytes is gRPC frame (compression + length)
    var head = bytes.splice(0, 5);

    // ensure we have proper message length
    var len = (head[1] &lt;&lt; 24)
              + (head[2] &lt;&lt; 16)
              + (head[3] &lt;&lt; 8)
              + head[4];

    if (len != bytes.length) {
        throw 'header length mismatch';
    }

    // invoke protobufjs to decode message
    var response = pb.helloworld.HelloReply.decode(bytes);

    console.log('Reply is:' + response.message);
}
</pre></blockquote><p> 
</p><a name="dnspacket"></a><center><h4>DNS-packet</h4></center><p>
This example uses a library for generation and parsing of DNS packets.
This a case worth considering because the library and its dependencies
use modern language constructions not yet supported by njs.
In turn, this requires from us an extra step: transpiling the source code.
</p><p>
Additional node packages are needed:
</p> <blockquote class="example"><pre>
$ npm install @babel/core @babel/cli @babel/preset-env babel-loader
$ npm install webpack webpack-cli
$ npm install buffer
$ npm install dns-packet
</pre></blockquote><p> 
The configuration file, webpack.config.js:
</p> <blockquote class="example"><pre>
const path = require('path');

module.exports = {
    entry: './load.js',
    mode: 'production',
    output: {
        filename: 'wp_out.js',
        path: path.resolve(__dirname, 'dist'),
    },
    optimization: {
        minimize: false
    },
    node: {
        global: true,
    },
    module : {
        rules: [{
            test: /\.m?js$$/,
            exclude: /(bower_components)/,
            use: {
                loader: 'babel-loader',
                options: {
                    presets: ['@babel/preset-env']
                }
            }
        }]
    }
};
</pre></blockquote><p> 
Note we are using "<code>production</code>" mode.
In this mode webpack does not use "<code>eval</code>" construction
not supported by njs.
The referenced <code>load.js</code> file is our entry point:
</p> <blockquote class="example"><pre>
global.dns = require('dns-packet')
global.Buffer = require('buffer/').Buffer
</pre></blockquote><p> 
We start the same way, by producing a single file for the libraries:
</p> <blockquote class="example"><pre>
$ npx browserify load.js -o bundle.js -d
</pre></blockquote><p> 
Next, we process the file with webpack, which itself invokes babel:
</p> <blockquote class="example"><pre>
$ npx webpack --config webpack.config.js
</pre></blockquote><p> 
This command produces the <code>dist/wp_out.js</code> file, which is a
transpiled version of <code>bundle.js</code>.
We need to concatenate it with <code>code.js</code>
that stores our code:
</p> <blockquote class="example"><pre>
function set_buffer(dnsPacket)
{
    // create DNS packet bytes
    var buf = dnsPacket.encode({
        type: 'query',
        id: 1,
        flags: dnsPacket.RECURSION_DESIRED,
        questions: [{
            type: 'A',
            name: 'google.com'
        }]
    })

    return buf;
}
</pre></blockquote><p> 
Note that in this example generated code is not wrapped into function and we
do not need to call it explicitly.
The result is in the "<code>dist</code>" directory:
</p> <blockquote class="example"><pre>
$ cat dist/wp_out.js code.js &gt; njs_dns_bundle.js
</pre></blockquote><p> 
Let's call our code at the end of a file:
</p> <blockquote class="example"><pre>
var b = set_buffer(global.dns);
console.log(b);
</pre></blockquote><p> 
And execute it using node:
</p> <blockquote class="example"><pre>
$ node ./njs_dns_bundle_final.js
Buffer [Uint8Array] [
    0,   1,   1, 0,  0,   1,   0,   0,
    0,   0,   0, 0,  6, 103, 111, 111,
  103, 108, 101, 3, 99, 111, 109,   0,
    0,   1,   0, 1
]
</pre></blockquote><p> 
Make sure this works as expected, and then run it with njs:
</p> <blockquote class="example"><pre>
$ njs ./njs_dns_bundle_final.js
Uint8Array [0,1,1,0,0,1,0,0,0,0,0,0,6,103,111,111,103,108,101,3,99,111,109,0,0,1,0,1]
</pre></blockquote><p> 

</p><p>
The response can be parsed as follows:
</p> <blockquote class="example"><pre>
function parse_response(buf)
{
    var bytes = buf.split('').map(v=&gt;v.charCodeAt(0));

    var b = global.Buffer.from(bytes);

    var packet = dnsPacket.decode(b);

    var resolved_name = packet.answers[0].name;

    // expected name is 'google.com', according to our request above
}
</pre></blockquote><p> 
</p></div></div></body></html>
